local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")

local localPlayer = Players.LocalPlayer
local camera = Workspace.CurrentCamera

local aimlock = false
local drawFOV = false
local aimSmoothness = 5
local aimFOV = 100
local aimKey = Enum.UserInputType.MouseButton2
local triggerbotEnabled = false
local magicBulletEnabled = false

local espEnabled = false
local boxEnabled = false
local filledBoxEnabled = false
local boneEnabled = false
local lineEnabled = false
local nameEnabled = false

local fovColor = Color3.fromRGB(255, 255, 255)
local boneColor = Color3.fromRGB(255, 0, 0)

-- Chargement de la UI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/xHeptc/Kavo-UI-Library/main/source.lua"))()
local Window = Library.CreateLib("Rivals Aimbot", "BloodTheme")

local AimbotTab = Window:NewTab("Aimbot")
local AimbotSection = AimbotTab:NewSection("Aimbot Settings")

AimbotSection:NewToggle("Enable Aimbot", "Active/Désactive l'aimbot", function(state)
    aimlock = state
end)

AimbotSection:NewToggle("Draw FOV", "Affiche le cercle du FOV", function(state)
    drawFOV = state
end)

AimbotSection:NewSlider("FOV", "Taille du cercle FOV", 50, 300, function(value)
    aimFOV = value
end)

AimbotSection:NewColorPicker("FOV Color", "Change la couleur du FOV", Color3.fromRGB(255, 255, 255), function(color)
    fovColor = color
end)

-- ESP Section
local EspTab = Window:NewTab("ESP")
local EspSection = EspTab:NewSection("ESP Settings")

EspSection:NewToggle("Enable ESP", "Affiche l'ESP sur les ennemis", function(state)
    espEnabled = state
end)

EspSection:NewToggle("Box", "Affiche une boîte autour des ennemis", function(state)
    boxEnabled = state
end)

EspSection:NewToggle("Filled Box", "Affiche une boîte remplie autour des ennemis", function(state)
    filledBoxEnabled = state
end)

EspSection:NewToggle("Bone", "Affiche les os des ennemis", function(state)
    boneEnabled = state
end)

EspSection:NewToggle("Line", "Affiche une ligne entre l'ennemi et le bas de l'écran", function(state)
    lineEnabled = state
end)

EspSection:NewToggle("Name", "Affiche le pseudo des ennemis", function(state)
    nameEnabled = state
end)

EspSection:NewColorPicker("Bone Color", "Change la couleur des os", Color3.fromRGB(255, 0, 0), function(color)
    boneColor = color
end)

-- FOV Drawing
local FOVCircle = Drawing.new("Circle")
FOVCircle.Thickness = 2
FOVCircle.NumSides = 50
FOVCircle.Filled = false
FOVCircle.Transparency = 1

RunService.RenderStepped:Connect(function()
    if drawFOV then
        FOVCircle.Color = fovColor
        FOVCircle.Position = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
        FOVCircle.Radius = aimFOV
        FOVCircle.Visible = true
    else
        FOVCircle.Visible = false
    end
end)

-- ESP Function
local function createESP(player)
    if player == localPlayer then return end
    if not player.Character then return end

    local highlight = Instance.new("Highlight", player.Character)
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0.2
    highlight.FillColor = Color3.fromRGB(255, 0, 0)

    local function updateESP()
        if not player.Character then return end
        if espEnabled then
            highlight.Enabled = true
        else
            highlight.Enabled = false
        end
    end

    RunService.RenderStepped:Connect(updateESP)
end

for _, player in pairs(Players:GetPlayers()) do
    createESP(player)
end

Players.PlayerAdded:Connect(createESP)

-- Aimbot Function
local function getClosestTarget()
    local closestTarget = nil
    local shortestDistance = aimFOV

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local headPosition, onScreen = camera:WorldToViewportPoint(player.Character.Head.Position)
            local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
            local distance = (Vector2.new(headPosition.X, headPosition.Y) - screenCenter).Magnitude

            if distance < shortestDistance then
                closestTarget = player
                shortestDistance = distance
            end
        end
    end

    return closestTarget
end

RunService.RenderStepped:Connect(function()
    if aimlock then
        local target = getClosestTarget()
        if target and target.Character and target.Character:FindFirstChild("Head") then
            local headPosition = camera:WorldToViewportPoint(target.Character.Head.Position)
            local screenCenter = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)

            local newMousePos = Vector2.new(
                screenCenter.X + (headPosition.X - screenCenter.X) / aimSmoothness,
                screenCenter.Y + (headPosition.Y - screenCenter.Y) / aimSmoothness
            )

            mousemoverel(newMousePos.X - screenCenter.X, newMousePos.Y - screenCenter.Y)
        end
    end
end)
